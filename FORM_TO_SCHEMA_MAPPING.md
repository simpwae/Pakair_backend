# Form to Database Schema Mapping

This document shows exactly how data from your frontend forms maps to the database schemas.

---

## 1. ğŸ” User Registration Form â†’ User Schema

### Frontend Form: `SignupPage.jsx`

**Form Fields:**
```javascript
{
  firstName: "",
  lastName: "",
  email: "",
  phone: "",
  password: "",
  agreeToTerms: false
}
```

### Database Schema: `User.js`

**Mapped Fields:**
```javascript
{
  firstName: String,        // âœ… Direct mapping
  lastName: String,         // âœ… Direct mapping
  email: String,            // âœ… Direct mapping (unique, validated)
  phone: String,            // âœ… Direct mapping (validated)
  password: String,         // âœ… Will be hashed before saving
  agreeToTerms: Boolean,    // âœ… Direct mapping (must be true)
  role: "citizen",          // ğŸ”„ Auto-set to "citizen"
  isVerified: false,        // ğŸ”„ Auto-set to false
  isActive: true,           // ğŸ”„ Auto-set to true
  createdAt: Date,          // ğŸ”„ Auto-generated by MongoDB
  updatedAt: Date           // ğŸ”„ Auto-generated by MongoDB
}
```

**API Endpoint Example:**
```javascript
POST /api/auth/register
Body: {
  "firstName": "Ahmed",
  "lastName": "Khan",
  "email": "ahmed@example.com",
  "phone": "+92-300-1234567",
  "password": "securepass123",
  "agreeToTerms": true
}
```

---

## 2. ğŸ“ Citizen Report Form â†’ CitizenReport Schema

### Frontend Form: `ReportSmog.jsx`

**Form Fields:**
```javascript
{
  file: File,                    // From file input/drag-drop
  useCurrent: true,              // Checkbox for current location
  address: "",                   // Manual address input
  description: ""                // Optional textarea
}
```

### Database Schema: `CitizenReport.js`

**Mapped Fields:**
```javascript
{
  // From authenticated user session
  userId: ObjectId,              // ğŸ”„ From req.user._id
  
  // From file upload
  media: {
    type: "image" | "video",     // ğŸ”„ Detected from file.mimetype
    url: String,                 // ğŸ”„ Generated after upload to storage
    filename: String,            // âœ… From file.originalname
    size: Number,                // âœ… From file.size
    mimeType: String             // âœ… From file.mimetype
  },
  
  // From form inputs + geolocation
  location: {
    useCurrentLocation: Boolean, // âœ… From useCurrent checkbox
    address: String,             // âœ… From address input
    coordinates: {
      latitude: Number,          // ğŸ”„ From browser geolocation API or manual
      longitude: Number          // ğŸ”„ From browser geolocation API or manual
    },
    city: String,                // ğŸ”„ Reverse geocoded or extracted
    province: String             // ğŸ”„ Reverse geocoded or extracted
  },
  
  // From form input
  description: String,           // âœ… From description textarea
  
  // Auto-generated fields
  verified: false,               // ğŸ”„ Default value
  status: "pending",             // ğŸ”„ Default value
  views: 0,                      // ğŸ”„ Default value
  likes: 0,                      // ğŸ”„ Default value
  createdAt: Date,               // ğŸ”„ Auto-generated
  updatedAt: Date                // ğŸ”„ Auto-generated
}
```

**Complete Data Flow:**

1. **User uploads file** â†’ Multer middleware processes â†’ File saved to storage
2. **User checks "Use Current Location"** â†’ Browser geolocation API â†’ Coordinates captured
3. **User enters description** â†’ Text captured
4. **Form submitted** â†’ All data sent to backend
5. **Backend processes** â†’ Creates CitizenReport document in MongoDB

**API Endpoint Example:**
```javascript
POST /api/reports
Headers: {
  "Authorization": "Bearer <jwt_token>"
}
Content-Type: multipart/form-data
Body: {
  "media": <File>,
  "useCurrentLocation": true,
  "latitude": 34.0151,
  "longitude": 71.5249,
  "address": "University Town, Peshawar",
  "description": "Heavy smog in the morning. Visibility reduced significantly."
}

Response: {
  "success": true,
  "data": {
    "_id": "507f1f77bcf86cd799439011",
    "userId": "507f1f77bcf86cd799439010",
    "media": {
      "type": "image",
      "url": "https://storage.example.com/reports/1699264200000-smog.jpg",
      "filename": "smog.jpg",
      "size": 2048576,
      "mimeType": "image/jpeg"
    },
    "location": {
      "useCurrentLocation": true,
      "address": "University Town, Peshawar",
      "coordinates": {
        "latitude": 34.0151,
        "longitude": 71.5249
      },
      "city": "Peshawar",
      "province": "Khyber Pakhtunkhwa"
    },
    "description": "Heavy smog in the morning. Visibility reduced significantly.",
    "verified": false,
    "status": "pending",
    "createdAt": "2024-11-06T10:30:00.000Z",
    "timeAgo": "2 hours ago"
  }
}
```

---

## 3. ğŸ­ AQI Station Form â†’ AQIStation Schema

### Frontend Form: `ReportSmog.jsx` (bottom section)

**Form Fields:**
```javascript
{
  stationName: "",    // Optional
  model: "",          // e.g., "PurpleAir"
  latitude: "",       // Manual input
  longitude: ""       // Manual input
}
```

### Database Schema: `AQIStation.js`

**Mapped Fields:**
```javascript
{
  // From authenticated user session
  submittedBy: ObjectId,         // ğŸ”„ From req.user._id
  
  // From form inputs
  stationName: String,           // âœ… From stationName input (optional)
  model: String,                 // âœ… From model input (required)
  
  location: {
    coordinates: {
      latitude: Number,          // âœ… From latitude input
      longitude: Number          // âœ… From longitude input
    },
    address: String,             // ğŸ”„ Reverse geocoded from coordinates
    city: String,                // ğŸ”„ Reverse geocoded from coordinates
    province: String,            // ğŸ”„ Reverse geocoded from coordinates
    country: "Pakistan"          // ğŸ”„ Default value
  },
  
  // Auto-generated fields
  stationType: "private",        // ğŸ”„ Default value
  verified: false,               // ğŸ”„ Default value
  status: "pending",             // ğŸ”„ Default value
  isActive: true,                // ğŸ”„ Default value
  isPublic: false,               // ğŸ”„ Default value
  createdAt: Date,               // ğŸ”„ Auto-generated
  updatedAt: Date                // ğŸ”„ Auto-generated
}
```

**API Endpoint Example:**
```javascript
POST /api/stations
Headers: {
  "Authorization": "Bearer <jwt_token>"
}
Body: {
  "stationName": "University Town Monitor",
  "model": "PurpleAir PA-II",
  "latitude": 34.0151,
  "longitude": 71.5249
}

Response: {
  "success": true,
  "data": {
    "_id": "507f1f77bcf86cd799439012",
    "submittedBy": "507f1f77bcf86cd799439010",
    "stationName": "University Town Monitor",
    "model": "PurpleAir PA-II",
    "location": {
      "coordinates": {
        "latitude": 34.0151,
        "longitude": 71.5249
      },
      "city": "Peshawar",
      "province": "Khyber Pakhtunkhwa",
      "country": "Pakistan"
    },
    "stationType": "private",
    "verified": false,
    "status": "pending",
    "createdAt": "2024-11-06T10:30:00.000Z"
  }
}
```

---

## 4. ğŸ”‘ Login Form â†’ User Schema (Query)

### Frontend Form: `LoginPage.jsx`

**Form Fields:**
```javascript
{
  email: "",
  password: ""
}
```

### Database Query:
```javascript
// Find user by email
const user = await User.findOne({ email: req.body.email })
  .select('+password'); // Include password field for verification

// Verify password (using bcrypt)
const isMatch = await bcrypt.compare(req.body.password, user.password);

if (isMatch) {
  // Generate JWT token
  const token = jwt.sign(
    { id: user._id, role: user.role },
    process.env.JWT_SECRET,
    { expiresIn: '7d' }
  );
  
  // Update last login
  user.lastLogin = new Date();
  await user.save();
  
  // Return token and user data
  return { token, user };
}
```

---

## ğŸ“Š Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend Forms    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ HTTP Request (JSON/FormData)
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Express Routes    â”‚
â”‚   /api/auth/*       â”‚
â”‚   /api/reports/*    â”‚
â”‚   /api/stations/*   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ Middleware (auth, upload, validation)
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Controllers       â”‚
â”‚   Business Logic    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ Mongoose Methods
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Mongoose Models   â”‚
â”‚   (Schemas)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ MongoDB Driver
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MongoDB Database  â”‚
â”‚   Collections:      â”‚
â”‚   - users           â”‚
â”‚   - citizenreports  â”‚
â”‚   - aqistations     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Complete Request/Response Examples

### Example 1: Submit Citizen Report

**Frontend Code:**
```javascript
const submitReport = async (formData) => {
  const data = new FormData();
  data.append('media', selectedFile);
  data.append('useCurrentLocation', useCurrent);
  data.append('latitude', position.coords.latitude);
  data.append('longitude', position.coords.longitude);
  data.append('address', address);
  data.append('description', description);
  
  const response = await fetch('/api/reports', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    },
    body: data
  });
  
  return response.json();
};
```

**Backend Controller:**
```javascript
export const createReport = async (req, res) => {
  try {
    // File is already processed by multer middleware
    const report = await CitizenReport.create({
      userId: req.user._id,
      media: {
        type: req.file.mimetype.startsWith('image') ? 'image' : 'video',
        url: `/uploads/${req.file.filename}`,
        filename: req.file.originalname,
        size: req.file.size,
        mimeType: req.file.mimetype
      },
      location: {
        useCurrentLocation: req.body.useCurrentLocation === 'true',
        address: req.body.address,
        coordinates: {
          latitude: parseFloat(req.body.latitude),
          longitude: parseFloat(req.body.longitude)
        }
      },
      description: req.body.description
    });
    
    res.status(201).json({ success: true, data: report });
  } catch (error) {
    res.status(400).json({ success: false, error: error.message });
  }
};
```

---

## âœ… Field Mapping Legend

- âœ… **Direct Mapping**: Field value comes directly from form input
- ğŸ”„ **Auto-Generated**: Field value is generated by backend/database
- ğŸ” **Derived**: Field value is calculated or extracted from other data

---

## ğŸ¯ Summary

### Forms Created âœ“
1. âœ… **SignupPage.jsx** â†’ User Schema
2. âœ… **LoginPage.jsx** â†’ User Schema (query)
3. âœ… **ReportSmog.jsx** â†’ CitizenReport Schema
4. âœ… **ReportSmog.jsx** (station section) â†’ AQIStation Schema

### Schemas Created âœ“
1. âœ… **User** - Complete with all signup fields
2. âœ… **CitizenReport** - Complete with media, location, description
3. âœ… **AQIStation** - Complete with station details
4. âœ… **HealthGuidance** - For health recommendations
5. âœ… **PolicyAdvisory** - For government alerts
6. âœ… **Notification** - For user notifications

### All form data can now be saved to the database! ğŸ‰

---

**Next Steps:**
1. Implement the controllers (see README_SCHEMAS.md)
2. Create the routes
3. Add authentication middleware
4. Set up file upload handling
5. Test the API endpoints
